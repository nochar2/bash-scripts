#!/bin/bash

### settings: adjust these ###
measuretime=10
samplerate=100
# samplerate=980
eventperiod=10000
### ---------------------- ####


# two options: X times per second, or once every X events
howtosample="-F $samplerate"
# howtosample="-c $eventperiod"

on_rpi()
{
	uname -n | grep rpi
}

if on_rpi; then
	# pi cannot record LLC misses
	whattosample="-e '{cycles,branch-misses,L1-dcache-load-misses}:ppp'"
else
	whattosample="-e '{cycles,branch-misses,L1-dcache-load-misses,LLC-load-misses}:ppp'"
fi

perfrecord="sudo perf record $howtosample $whattosample  --call-graph dwarf,2048 --mmap-pages 16M -z --sample-cpu --"
uv="$HOME/zmisc/git-repos/UltraGrid/ug-myfork/bin/uv"
# uv="$HOME/uv"

piaddr=169.254.2.2
uvviddir=/home/karel/vid/ugvid/y4m
uvfilersg=ReadySetGo_1920x1080_120fps_420_8bit_YUV.y4m
uvfile="${uvviddir}/${uvfilersg}"


checkforroot()
{
	[ $EUID = 0 ] || { echo "perf requires root to start"; exit 1; }
}

usage()
{ 
	echo "usage: $0 [-n] [-v] [-g] [-l] [file|rtdxt|screen|logotext|network|...] [MTU]"
	echo "calls UltraGrid with arguments for the given scenario."
	echo "-n   does not use  perf record"
	echo "-v   uses valgrind"
	echo "-g   uses gdb"
	echo "-l   instead of sending the video, display it locally on sdl screen"
	echo "MTU: himtu, 9000, 9k  sets it to 9000"
	echo "     lomtu, 1500, 1k5 sets it to 1500"

	exit 1; 
}

main() 
{
	# default measuring
	pr="timeout $measuretime $perfrecord"
	
	out="$piaddr"
	
	# alternatives
	while getopts "nvgl" opt; do
		case "$opt" in
			n) pr="";;
			v) pr="valgrind";;
			g) pr="gdb --args";;
			l) out="-d sdl";;
		esac
	done
	shift $((OPTIND-1))


	[ -z "$1" ] && { usage; exit 1; }
	
	[[ "$pr" =~ "^perf" ]] && checkforroot

	mtu=1500
	case "$2" in
		himtu|9000|9k) mtu=9000;;
		lomtu|1500|1k5) mtu=1500;;
	esac

	case "$1" in
		file) cmd="$pr $uv -m $mtu -t file:${uvfile}:loop -c libavcodec $out";
			:;;
		rtdxt) 
			cmd="$pr $uv -m $mtu -t file:${uvfile}:loop -c rtdxt:dxt1 $out";
			:;;
		screen)
			cmd="$pr $uv -m $mtu -t screen:fps=60 -c libavcodec $out";
			:;;
		network)
			# TODO
			cmd="$pr $uv -m $mtu -t testcard:fps=1000 -d dummy $out";
			:;;
		deinterlace)
			# TODO
			cmd="$pr $uv -m $mtu -t testcard:fps=1000 -d dummy $out";
			:;;
		logotext)
			cmd="$pr $uv -m $mtu -t file:${uvfile}:loop -F logo:pic/uglogo.pam -F text:x=500:y=500:h=80:t=two_weeks_before_deadline√Å $out";
			:;;
		*) usage; exit 1;;
	esac

	echo "cmd is:"
	echo "$cmd"
	echo "$pr $uv"
	echo Running "$cmd" for "$measuretime" seconds.

	# necessary to split args, sadly breaks spaces
	$cmd

}

main "$@"
