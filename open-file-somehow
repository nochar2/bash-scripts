#!/bin/bash
# ^ don't ever run shell scripts interactively with -i, this destroys your history

# don't know why this works
args-to-lines() {
    for line in "$@"; do
        echo -en "$line\n"
    done
}

dmenu-with-opts() {
    IFS=" "
    prompt="How should I open this?"
    echo $(args-to-lines "$@") | dmenu -p "$prompt"
}

suitable-program-for() {
    filename="$1"
    mime=$(file -L -b --mime-type "$filename")
    case "$mime" in
        application/epub+zip) echo zathura;;
        application/json) dmenu-with-opts "jq ." vim kwrite;;
        application/pdf) echo zathura;;
        application/javascript) echo $EDITOR;;  # .lua is detected as this
        audio/*) echo command mpv;;
        document/*) echo zathura;;
        html/*) echo firefox;;
        image/vnd.djvu) echo zathura;;
        image/*) echo sxiv;;
        inode/directory) echo dolphin;;
        inode/x-empty) echo $EDITOR;;
        text/*) echo $EDITOR;;
        video/*) echo mpv;;
        application/vnd.ms-htmlhelp) echo kchmviewer;;
        *) echo xdg-open;;
    esac
}

can-swallow()
{
    # how do I check if i3 is running?
    # ??? && echo swallow || echo ""
    pgrep i3 >/dev/null && echo "swallow" || echo ""
}

whattorun() {
    echo "whattorun is run with these arguments:" >&2
    echo "$@" >&2

    # spawn in a new terminal if -t is given
    termprefix=""
    [ "$1" = "-t" ] && { termprefix="$TERMINAL -e "; shift; }
        
    # bandaid fix, should fix how this script is really called
    file="$*"
    program="$(suitable-program-for "$file")"

    echo "suitable-program-for returned $program for $file" >&2

    case "$program" in
        zathura|sxiv) 
            echo $termprefix $(can-swallow) $program \"$file\"
        ;;
        $EDITOR) 
            if [ -w "$file" ]; then 
                 echo $termprefix $EDITOR "$file";
             else
                 echo "Not writable, trying sudoedit..." >&2;
                 echo $termprefix sudoedit \"$file\";
             fi
        ;;
        "") echo "bug in suitable-program-for, should return xdg-open" >&2; exit 1;;
        *) echo $termprefix $program "$file";;  # program is unquoted to allow for args
    esac
}

wholecmd="$(whattorun $@)"

# thanks Luke (youtu.be/QXineadwG4E)
cmd="${wholecmd%% *}"
args="${wholecmd#* }"
echo cmd is $cmd
echo args is $args
"$cmd" "${args[@]}"

echo "$wholecmd" >> $HOME/.local/state/bash/history
