#!/bin/bash
# shellcheck disable=SC2002 # useless "useless cat" remarks

# XXX: having a / inside one of these files breaks this thing
set -euo pipefail

################ files ########################################
tmppath=/tmp/dashboard             # temp files
ptd=$HOME/notes/_priv-todostack.md
bpwtd=$HOME/muni/bp/notes/work/bpwork-todostack.md
bpttd=$HOME/muni/bp/notes/text/bptext-todostack.md
wallpaper="$(xdg-user-dir PICTURES)/wallpaper" # this actually remains fixed
# wallpaper_desc='$(xdg-user-dir PICTURES)/wallpaper' # idk how to expand this
###############################################################

usage()
{
	echo "$(basename "$0"): Draws note boxes on your wallpaper from your .md file."
	echo ""
	echo "This gets drawn:           This doesn't:"
	echo "# To do                    # -- Really detailed plan"
	echo "- create a thing           long verbose notes"
	echo "- document it              more notes"
	echo "- ...                      more notes"
	echo "                           more notes"
	echo "                           more notes"
	echo "                           more notes"
	echo "Requires the   boxes   binary. Also, it works ok-ish for me, but there are bugs."
}



mkdir -p $tmppath

escape_slashes_1()
{
	echo "$1" | sed 's/\//\\\//g'
}

cut_md_section()
{
	# section="$1"
	sed -n "/^# $1/,/^#/p;" | sed "1 d;" | cat --squeeze-blank
}

box_with_title()
{
	boxes -d boxquote | sed "1s/.*/,----[ $(escape_slashes_1 "$1") ]/"
}

cut_and_embox()
{
	# [ -z "$2" ] && set "$1" "$1"
	cut_md_section "$1" | box_with_title "${2:-$1}"
}

list_recent_files_in()
{
	# shellcheck disable=SC2010
	ls --time=ctime --classify "$1" | grep -v "[/@*]$" | head
}

# pad_to_ideal_width()
# {
# 	width=$(wc -L "$1" | cut -d" " -f1)
# 	cat "$1" | (IFS="\n"; while read r; do
# 		printf "%s%*s\n" "$r" "$[$width - $(wc -L <<< "$r")]" "";
# 	done)
# }

put_next_to_each_other()
{
	# pr which actually works with UTF-8 characters
	# see the C source, don't think there's a coreutil
	# it's definitely nontrivial to do with bash programs
	sanepr "$@"
}

cut_and_embox_each_chunk()
{
	rejoined=""
	chunk=""
	title=""
	actually_bother_reading_this_line=1;
	IFS=$'\n'
	while read -r l; do
		# the regex on the rhs *has* to be unquoted
		# title that starts with - is an ignored section
		if [[ "$l" =~ ^#+\ - ]]; then
			actually_bother_reading_this_line=0;
		# title that doesn't start with - is ok
		elif [[ "$l" =~ ^#\ [^-] ]]; then
			title="${l### }"
			actually_bother_reading_this_line=1;
		fi

		if [ 0 -eq "$actually_bother_reading_this_line" ]; then
			continue;
		fi

		# empty line == end of chunk
		if [ -z "$l" ]; then
			if [ -n "$chunk" ]; then
				rejoined="$rejoined
$( (fold -w 80 -s | cut_and_embox "$title") <<< "$chunk")
";
				chunk="";
			fi
			actually_bother_reading_this_line=0;
		else
			# newline!
			chunk="$chunk
$l";
		fi
	done

	echo "$rejoined"
}

recreate()
{
	printf "%s\n-------------------\n" "$ptd"   >$tmppath/col1
	cat "$ptd" | cut_and_embox_each_chunk       >>$tmppath/col1
	printf "%s\n-------------------\n" "$bpttd" >$tmppath/col2
	cat "$bpttd" | cut_and_embox_each_chunk     >>$tmppath/col2
	printf "%s\n-------------------\n" "$bpwtd" >$tmppath/col3
	cat "$bpwtd" | cut_and_embox_each_chunk     >>$tmppath/col3
		
	put_next_to_each_other $tmppath/col* >$tmppath/result

	# used to have  -size 1600x900 xc:black   for a blank pic
		# -font "helvetica" -pointsize 18 -fill white \

	# -colorize 50% makes this image darker if you want that
	convert "$wallpaper" \
		-fill black \
		-font "JetBrains-Mono-Light" \
		-pointsize 17 \
		-fill white \
		-gravity center \
		-annotate +30+30 \
		"@$tmppath/result" \
		$tmppath/result.jpg

	xwallpaper --center $tmppath/result.jpg
}

mainloop()
{
	recreate
	inotifywait -e "close_write" \
		"$ptd" "$bpwtd" "$bpttd" "$wallpaper" "$HOME/scripts/sanepr" "$0" || true;
	exec "$0" "$@"    # reload yourself
}

main()
{
	case "$*" in
		-h|--help) usage; exit 0;;
	esac 
	[ "$(pgrep dashboard | wc -l)" -gt 2 ] && {
		notify-send "dashboard" "Another instance is already running."
		exit 1
	}
	mainloop "$@"
}
# set -x
echo "XXX: still broken completely, just work you retard"
# main "$@"

# cat "$ptd" | cut_md_section ".*"
# cat "$ptd" | cut_and_embox_each_chunk
